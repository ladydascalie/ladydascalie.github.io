<!doctype html>
<html lang="en">
        <head>
                <meta charset="UTF-8" />
                <meta
                        name="viewport"
                        content="width=device-width, initial-scale=1.0"
                />
                <title>Loading Theme...</title>
                <style>
                        body {
                                margin: 0;
                                padding: 20px;
                                font-family: Arial, sans-serif;
                                background: #f0f0f0;
                                display: flex;
                                justify-content: center;
                                align-items: center;
                                min-height: 100vh;
                        }

                        .loading {
                                text-align: center;
                                padding: 40px;
                                background: white;
                                border-radius: 8px;
                                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                                max-width: 400px;
                        }

                        .loading h2 {
                                margin: 0 0 20px 0;
                                color: #333;
                        }

                        .spinner {
                                border: 4px solid #f3f3f3;
                                border-top: 4px solid #3498db;
                                border-radius: 50%;
                                width: 40px;
                                height: 40px;
                                animation: spin 1s linear infinite;
                                margin: 20px auto;
                        }

                        @keyframes spin {
                                0% {
                                        transform: rotate(0deg);
                                }
                                100% {
                                        transform: rotate(360deg);
                                }
                        }

                        .error {
                                color: #e74c3c;
                                background: #fff5f5;
                                border: 1px solid #e74c3c;
                                padding: 20px;
                                border-radius: 4px;
                                margin-top: 20px;
                        }

                        .available-themes {
                                margin-top: 20px;
                                text-align: left;
                        }

                        .available-themes a {
                                display: block;
                                margin: 5px 0;
                                color: #3498db;
                                text-decoration: none;
                        }

                        .available-themes a:hover {
                                text-decoration: underline;
                        }

                        .hidden {
                                display: none;
                        }
                </style>
        </head>
        <body>
                <div class="loading" id="loadingContainer">
                        <h2>Loading Theme...</h2>
                        <div class="spinner"></div>
                        <div id="statusMessage">
                                Initializing theme system...
                        </div>
                        <div class="error hidden" id="errorContainer"></div>
                        <div
                                class="available-themes hidden"
                                id="availableThemes"
                        >
                                <h3>Available Themes:</h3>
                        </div>
                </div>

                <script>
                        class ThemeRenderer {
                                constructor() {
                                        this.loadingContainer =
                                                document.getElementById(
                                                        "loadingContainer",
                                                );
                                        this.statusMessage =
                                                document.getElementById(
                                                        "statusMessage",
                                                );
                                        this.errorContainer =
                                                document.getElementById(
                                                        "errorContainer",
                                                );
                                        this.availableThemes =
                                                document.getElementById(
                                                        "availableThemes",
                                                );
                                }

                                async init() {
                                        try {
                                                // Get theme from URL parameter
                                                const urlParams =
                                                        new URLSearchParams(
                                                                window.location.search,
                                                        );
                                                const themeName =
                                                        urlParams.get("theme");

                                                if (!themeName) {
                                                        this.showError(
                                                                "No theme specified. Please add ?theme=themename to the URL.",
                                                        );
                                                        this.showAvailableThemes();
                                                        return;
                                                }

                                                this.updateStatus(
                                                        "Loading content data...",
                                                );
                                                await this.loadScript(
                                                        "src/content-data.js",
                                                );

                                                this.updateStatus(
                                                        "Loading template engine...",
                                                );
                                                await this.loadScript(
                                                        "src/template-engine.js",
                                                );

                                                this.updateStatus(
                                                        `Loading ${themeName} theme...`,
                                                );
                                                await this.loadScript(
                                                        `src/themes/${themeName}/template.js`,
                                                );

                                                this.updateStatus(
                                                        "Rendering theme...",
                                                );
                                                await this.renderTheme(
                                                        themeName,
                                                );
                                        } catch (error) {
                                                console.error(
                                                        "Theme loading error:",
                                                        error,
                                                );
                                                this.showError(
                                                        `Failed to load theme: ${error.message}`,
                                                );
                                                this.showAvailableThemes();
                                        }
                                }

                                async loadScript(src) {
                                        return new Promise(
                                                (resolve, reject) => {
                                                        const script =
                                                                document.createElement(
                                                                        "script",
                                                                );
                                                        script.src = src;
                                                        script.onload = resolve;
                                                        script.onerror = () =>
                                                                reject(
                                                                        new Error(
                                                                                `Failed to load ${src}`,
                                                                        ),
                                                                );
                                                        document.head.appendChild(
                                                                script,
                                                        );
                                                },
                                        );
                                }

                                async renderTheme(themeName) {
                                        // Wait a moment for scripts to initialize
                                        await new Promise((resolve) =>
                                                setTimeout(resolve, 100),
                                        );

                                        if (
                                                typeof PROFILE_DATA ===
                                                "undefined"
                                        ) {
                                                throw new Error(
                                                        "Content data not loaded",
                                                );
                                        }

                                        if (
                                                typeof templateEngine ===
                                                "undefined"
                                        ) {
                                                throw new Error(
                                                        "Template engine not loaded",
                                                );
                                        }

                                        const theme =
                                                templateEngine.getTheme(
                                                        themeName,
                                                );
                                        if (!theme) {
                                                throw new Error(
                                                        `Theme '${themeName}' not found. Make sure the theme file registers itself with the template engine.`,
                                                );
                                        }

                                        // Render the theme (now async)
                                        const renderedHTML =
                                                await templateEngine.render(
                                                        themeName,
                                                        PROFILE_DATA,
                                                );

                                        // Replace the entire document with the rendered theme
                                        document.open();
                                        document.write(renderedHTML);
                                        document.close();
                                }

                                updateStatus(message) {
                                        this.statusMessage.textContent =
                                                message;
                                }

                                showError(message) {
                                        this.errorContainer.textContent =
                                                message;
                                        this.errorContainer.classList.remove(
                                                "hidden",
                                        );
                                }

                                showAvailableThemes() {
                                        const themes = [
                                                {
                                                        name: "cypherpunk",
                                                        display: "Cypherpunk Terminal",
                                                },
                                                {
                                                        name: "retro-90s",
                                                        display: "Retro 90s Website",
                                                },
                                        ];

                                        themes.forEach((theme) => {
                                                const link =
                                                        document.createElement(
                                                                "a",
                                                        );
                                                link.href = `?theme=${theme.name}`;
                                                link.textContent =
                                                        theme.display;
                                                this.availableThemes.appendChild(
                                                        link,
                                                );
                                        });

                                        this.availableThemes.classList.remove(
                                                "hidden",
                                        );
                                }
                        }

                        // Initialize the theme renderer
                        const renderer = new ThemeRenderer();
                        renderer.init();
                </script>
        </body>
</html>
